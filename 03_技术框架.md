# Clerk Auth

## å¹³å°ä¿¡æ¯

github account login

[API KEY](https://dashboard.clerk.com/apps/app_2h3rVTIOKEjDPMvkButuenB43ro/instances/ins_2h3rVayUgo9oHxXrn0Wi3DaLVqX/api-keys)è®¾ç½®åˆ° env ä¸­<br/>
![alt text](99_screenshot/clerk_config.png)

## è®¤è¯ä¸­é—´ä»¶

src\middleware.ts<br/>
ç”¨æ¥æµ‹è¯•ä¸­é—´ä»¶æ‹¦æˆªå™¨é¡µé¢çš„é¡µé¢:src\app\(studio)\studio\page.tsx

# DB

## postgre

è°·æ­Œé‚®ç®±ç™»å½•
[neon postgresql](https://console.neon.tech/app/projects/billowing-unit-66449389?database=metube)<br/>
![alt text](99_screenshot/db_config.png)

## redis

å¼•å…¥ redis å¯¹è®¤è¯ç™»å½•è¯·æ±‚è®¡æ•°ï¼Œé™åˆ¶æ¶æ„æš´åˆ·æˆ‘ä»¬çš„ clerk è®¤è¯æœåŠ¡ã€‚
ä»£ç å®ç°ï¼š
src\trpc\init.ts
src\lib\ratelimit.ts

è°·æ­Œé‚®ç®±ç™»å½•[æ— æœåŠ¡å¹³å° upstash](https://console.upstash.com/)
![alt text](99_screenshot/redis.png)
![alt text](99_screenshot/redisAPI.png)

# drizzle

Drizzle æ˜¯ä¸€ä¸ªç°ä»£çš„ TypeScript ä¼˜å…ˆ çš„ ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰å·¥å…·ï¼Œå®ƒè¯ç”Ÿæ˜¯ä¸ºäº†è§£å†³ä»¥ä¸‹å‡ ä¸ªæ•°æ®åº“å¼€å‘ä¸­çš„ç—›ç‚¹ï¼š<br/>
![alt text](99_screenshot/drizzle_why.png)

drizzle sample<br/>
![alt text](99_screenshot/drizzle_sample.png)

drizzle vs prisma<br/>
![alt text](99_screenshot/drizzle_vs_prisma.png)

## Drizzle vs Prisma å¯¹æ¯”è¡¨

| ç‰¹æ€§               | ğŸ§ª Drizzle ORM                             | ğŸŒˆ Prisma ORM                               |
| ------------------ | ------------------------------------------ | ------------------------------------------- |
| **è¯­è¨€é£æ ¼**       | TypeScript-firstï¼Œæ˜¾å¼ä»£ç                  | Schema-firstï¼Œä½¿ç”¨ Prisma è‡ªå®šä¹‰ DSL        |
| **SQL å¯è§æ€§**     | âœ… æ˜¾å¼æ„å»º SQLï¼ŒSQL è¯­ä¹‰å¯è¯»              | âŒ è‡ªåŠ¨ç”ŸæˆæŸ¥è¯¢ï¼ŒSQL ä¸å¯è§                 |
| **ç±»å‹å®‰å…¨**       | âœ… å®Œå…¨ç±»å‹å®‰å…¨ï¼Œæ¨å¯¼åˆ°å­—æ®µçº§              | âœ… æŸ¥è¯¢ç»“æœç±»å‹å®‰å…¨ï¼ˆä½† SQL æ„å»ºä¸é€æ˜ï¼‰    |
| **è¿ç§»æœºåˆ¶**       | âœ… ä»£ç å³ schemaï¼Œå¼ºä¸€è‡´æ€§                 | âŒ éœ€è¦é¢å¤–ç»´æŠ¤ `.prisma` schema å’Œè¿ç§»æ–‡ä»¶ |
| **è¿è¡Œæ—¶ä¾èµ–**     | âŒ æ— è¿è¡Œæ—¶é­”æ³•æˆ–ç”Ÿæˆå™¨                    | âœ… ä¾èµ–ä»£ç ç”Ÿæˆå™¨å’Œè¿è¡Œæ—¶å®¢æˆ·ç«¯             |
| **å­¦ä¹ æ›²çº¿**       | âœ… ç†Ÿæ‚‰ SQL å°±èƒ½ç”¨                         | â›” éœ€è¦å­¦ä¹  Prisma schema DSL               |
| **è°ƒè¯•ä½“éªŒ**       | âœ… SQL å¯è§ï¼Œæ˜“è°ƒè¯•                        | âŒ SQL éšè—ï¼Œè°ƒè¯•éœ€ä¾èµ–æ—¥å¿—                 |
| **æ€§èƒ½å¼€é”€**       | âœ… æè½»é‡ã€æ—  ORM ä¸­é—´å±‚                   | â›” Prisma Client è¾ƒé‡ï¼Œå¯èƒ½å½±å“å†·å¯åŠ¨       |
| **ä½¿ç”¨ç¯å¢ƒå…¼å®¹æ€§** | âœ… æ”¯æŒ Edge Functionsã€Bunã€Serverless    | âŒ åœ¨æŸäº› Edge ç¯å¢ƒä¸­è¿è¡Œä¸ç¨³å®š             |
| **æ•°æ®åº“æ”¯æŒ**     | PostgreSQLã€MySQLã€SQLiteï¼ˆè®¡åˆ’æ”¯æŒæ›´å¤šï¼‰  | PostgreSQLã€MySQLã€SQLiteã€MongoDB ç­‰       |
| **ç¤¾åŒºä¸ç”Ÿæ€**     | æ–°å…´ä¸­ï¼Œè½»é‡çº§æ–¹å‘                         | æˆç†Ÿã€ç”Ÿæ€ä¸°å¯Œ                              |
| **é€‚åˆäººç¾¤**       | æ³¨é‡æ€§èƒ½ã€å–œæ¬¢ SQLã€é‡è§†ç±»å‹ä¸€è‡´æ€§çš„å¼€å‘è€… | è¿½æ±‚å¼€å‘æ•ˆç‡ã€è‡ªåŠ¨åŒ–ã€ä¼ä¸šé¡¹ç›®              |

## Get Start

neon postgresql:https://orm.drizzle.team/docs/get-started/neon-new
<br/>
local postgresql:https://orm.drizzle.team/docs/get-started/postgresql-new

## æ¨é€æ•°æ®åº“è¡¨

1. åœ¨ db æ–‡ä»¶å¤¹ä¸­å®Œæˆä¸‹é¢ä¸‰ä¸ªåŸºç¡€æ–‡ä»¶åˆ›å»ºã€‚<br/>
   drizzle.config.ts<br/>
   src\db\index.ts<br/>
   src\db\schema.ts<br/>
2. é€šè¿‡ drizzle-kit å‘½ä»¤åŒ…ä¸­çš„ push å‘½ä»¤ï¼Œæ¨é€ Table åˆ°æ•°æ®åº“ä¸­ã€‚<br/>
   **â˜… æ¯æ¬¡ä¿®æ”¹å„ä¸ªè¡¨çš„ schema éƒ½éœ€è¦æ¨é€**<br/>
   bunx drizzle-kit push

```bash
PS D:\02_ALL_WORKSPACE\reactWK\nextjs-study\next15-youtube-clone> bunx drizzle-kit push
No config path provided, using default 'drizzle.config.ts'
Reading config file 'D:\02_ALL_WORKSPACE\reactWK\nextjs-study\next15-youtube-clone\drizzle.config.ts'Using '@neondatabase/serverless' driver for database querying
 Warning  '@neondatabase/serverless' can only connect to remote Neon/Vercel Postgres/Supabase instances through a websocket
[âœ“] Pulling schema from database...
[âœ“] Changes applied
```

æ¨é€å®Œæˆåå»æ•°æ®åº“ç¡®è®¤è¡¨åˆ›å»ºæˆåŠŸ<br/>
![alt text](99_screenshot/drizzle_kit_push_table_users.png)

å®Œæˆ drizzle çš„è¡¨æ¨é€åï¼Œä¹Ÿå¯ä»¥é€šè¿‡ drizzle çš„ studio å®¢æˆ·ç«¯æ‰“å¼€æ•°æ®åº“ã€‚

```bash
bunx drizzle-kit studio
```

## relations

åœ¨ä»£ç å±‚é¢å¸®åŠ©æˆ‘ä»¬å®Œæˆè¡¨å…³è”æŸ¥è¯¢çš„è¯­æ³•ï¼Œç›¸å½“äºåœ¨ java ä¸­å–å‡ºä¸¤ä¸ªè¡¨çš„ list é›†åˆï¼Œå†é€šè¿‡éå†æ¥å…³è”ä¸¤ä¸ªé›†åˆå¾—åˆ°ä¸€ä¸ªæ–°çš„é›†åˆ<br/>
ä»¥ä¸‹æ˜¯å®˜ç½‘å¯¹æ¯”ä½¿ç”¨ relations å’Œ leftJoin çš„åŒºåˆ«<br/>
https://orm.drizzle.team/docs/relations

# Webhook Sync

Webhook Sync çš„è¯ç”Ÿæ˜¯ä¸ºäº†æ›¿ä»£ä½æ•ˆçš„è½®è¯¢æ¨¡å¼ï¼Œé€šè¿‡äº‹ä»¶é©±åŠ¨æ¨¡å¼å®ç°â€”â€”ä»…åœ¨æ•°æ®å˜åŒ–æ—¶ä¸»åŠ¨æ¨é€ï¼ˆPushï¼‰ï¼Œé¿å…æ— æ•ˆæŸ¥è¯¢ã€‚
**å…¶å®å°±æ˜¯ç»™ç¬¬ä¸‰æ–¹æœåŠ¡æä¾›ä¸€ä¸ªæˆ‘ä»¬è‡ªå®šä¹‰çš„ APIï¼Œè®©ç¬¬ä¸‰æ–¹æœåŠ¡ä¸»åŠ¨è°ƒç”¨æˆ‘ä»¬çš„ APIã€‚**<br/>
åœ¨æˆ‘ä»¬è¿™ä¸ªé¡¹ç›®ä¸­çš„å®é™…åº”ç”¨æœ‰ä»¥ä¸‹å‡ å¤„ï¼š

1. clerk å¹³å°å¯¹ user è¿›è¡Œå¢åˆ æ”¹æ—¶ï¼Œè°ƒç”¨æˆ‘ä»¬çš„ API ç»´æŠ¤ user è¡¨ã€‚[è¯¦ç»†](## clerk-webhook)

Webhook Sync è§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼š<br/>
(1) å®æ—¶æ€§éœ€æ±‚<br/>
åœºæ™¯ï¼šæ”¯ä»˜æˆåŠŸé€šçŸ¥ã€è®¢å•çŠ¶æ€æ›´æ–°ã€GitHub ä»£ç æ¨é€ç­‰ã€‚<br/>
æ–¹æ¡ˆï¼šæœåŠ¡æ–¹ï¼ˆå¦‚æ”¯ä»˜ç³»ç»Ÿï¼‰é€šè¿‡ Webhook ç«‹å³ å°†äº‹ä»¶æ¨é€ç»™è®¢é˜…æ–¹ï¼Œå®ç°ç§’çº§åŒæ­¥ã€‚

(2) ç³»ç»Ÿè§£è€¦<br/>
é—®é¢˜ï¼šç´§è€¦åˆç³»ç»Ÿï¼ˆå¦‚ç›´æ¥ API è°ƒç”¨ï¼‰ä¼šå› ä¾èµ–æ–¹æ•…éšœå¼•å‘è¿é”ååº”ã€‚<br/>
æ–¹æ¡ˆï¼šWebhook é€šè¿‡ HTTP å›è°ƒé€šçŸ¥ï¼Œå‘é€æ–¹å’Œæ¥æ”¶æ–¹å®Œå…¨è§£è€¦ï¼Œä»…éœ€çº¦å®šæ¶ˆæ¯æ ¼å¼ã€‚

(3) é™ä½æœåŠ¡å™¨å‹åŠ›<br/>
å¯¹æ¯”è½®è¯¢ï¼š1000 ä¸ªå®¢æˆ·ç«¯è½®è¯¢ 1 æ¬¡/ç§’ â†’ æ¯ç§’ 1000 æ¬¡è¯·æ±‚ã€‚<br/>
Webhook æ¨¡å¼ï¼šåªæœ‰äº‹ä»¶å‘ç”Ÿæ—¶è§¦å‘ï¼Œå¯èƒ½å…¨å¤©ä»…éœ€ 10 æ¬¡è¯·æ±‚ã€‚<br/>

## [ngrok](https://dashboard.ngrok.com/get-started/setup/windows)

å› ä¸ºç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆå¦‚ï¼šclerkï¼‰æ— æ³•ç›´æ¥å‘é€è¯·æ±‚åˆ°æˆ‘ä»¬çš„ localhost ä¸Šï¼Œåªèƒ½å‘é€è¯·æ±‚åˆ°ä¸€ä¸ªå¯¹å¤–å…¬å¸ƒçš„åŸŸåã€‚<br/>
å› æ­¤éœ€è¦é€šè¿‡ä¸‹é¢æ­¥éª¤å»ºç«‹ä¸€ä¸ªé™æ€åŸŸåæ˜ å°„ï¼Œä¾¿äºå°† webhook çš„è¯·æ±‚è½¬å‘ç»™ localhost

1. choco install ngrok åœ¨ windows ä¸Šä¼šå› ä¸ºæ€æ¯’è½¯ä»¶å¯¼è‡´ access errorï¼Œå»ºè®®ç›´æ¥åœ¨ä¸Šé¢å®˜ç½‘ä¸‹è½½ ngrok.exeï¼Œæ‰“å¼€ ngrok.exe æ–‡ä»¶å¼¹å‡º cmd å¯¹è¯æ¡†ã€‚<br/>
   D:\03_software\ngrok-v3-stable-windows-amd64\ngrok.exe
2. æŒ‰ç…§å®˜ç½‘ step2 é…ç½® ngrok config add-authtokenï¼Œ<br/>
   æ–‡ä»¶è·¯å¾„ï¼šC:\Users\Zhupeng\AppData\Local/ngrok/ngrok.ymlã€‚
   ![alt text](99_screenshot/ngrok_create_config.png)
3. bun run dev,é»˜è®¤ port åº”è¯¥æ˜¯ 3000
4. å»ºç«‹åŸŸåä¸ localhost300 çš„æ˜ å°„:<br/>
   ngrok http --url=tightly-prompt-halibut.ngrok-free.app 3000
   <br/>å¦‚æœä¸Šé¢çš„å‘½ä»¤è¿è¡Œé”™è¯¯ï¼Œè¯•è¯•æŠŠ--url æ”¹æˆ--domain
   ![alt text](99_screenshot/ngrok_connect.png)

## [clerk webhook](https://dashboard.clerk.com/apps/app_2h3rVTIOKEjDPMvkButuenB43ro/instances/ins_2h3rVayUgo9oHxXrn0Wi3DaLVqX/webhooks)

1. æ–°å»ºä¸€ä¸ª webhook endpoint<br/>
   ![alt text](99_screenshot/clerk_webhook_create.png)
2. æŠŠ Signing Secret è®¾ç½®åˆ° env ä¸­
   ![alt text](99_screenshot/clerk_webhook_signing_secret.png)

## Svix

Svix çš„è¯ç”Ÿæ˜¯ä¸ºäº†è§£å†³ ä¼ä¸šçº§ Webhook å¯é æ€§å’Œè§„æ¨¡åŒ– çš„æ ¸å¿ƒé—®é¢˜ã€‚ä»¥ä¸‹æ˜¯å…¶æ ¸å¿ƒå®šä½å’Œè§£å†³çš„ç—›ç‚¹ï¼š<br/>

### åŸç”Ÿ Webhook çš„å±€é™æ€§

å¼€å‘è€…ç›´æ¥ä½¿ç”¨ Webhook æ—¶é¢ä¸´çš„ä¸»è¦æŒ‘æˆ˜ï¼š

1. å¯é æ€§å·®ï¼šæ¥æ”¶æ–¹æœåŠ¡å®•æœºæˆ–ç½‘ç»œæ³¢åŠ¨ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚
2. ç¼ºä¹å¯è§‚æµ‹æ€§ï¼šæ— æ³•è¿½è¸ª Webhook çš„é€è¾¾çŠ¶æ€ã€é‡è¯•å†å²ã€‚
3. å®‰å…¨é£é™©ï¼šä¼ªé€ è¯·æ±‚ï¼ˆå¦‚ä¸­é—´äººæ”»å‡»ï¼‰ã€ç­¾åéªŒè¯å¤æ‚ã€‚
4. è§„æ¨¡åŒ–å›°éš¾ï¼šé«˜å¹¶å‘ä¸‹è‡ªå»º Webhook ç³»ç»Ÿéš¾ä»¥ä¿è¯æ€§èƒ½å’Œé¡ºåºæ€§ã€‚

## æµ‹è¯• webhook æ˜¯å¦æ­£å¸¸è¿è¡Œ

ç™»å½•è‡ªå·±çš„ clerkï¼Œæ‰“å¼€[users ç®¡ç†ç•Œé¢](https://dashboard.clerk.com/apps/app_2h3rVTIOKEjDPMvkButuenB43ro/instances/ins_2h3rVayUgo9oHxXrn0Wi3DaLVqX/users),éšæ„è¿›è¡Œå¢åˆ æŸ¥æ”¹çš„æ“ä½œï¼Œ<br/>
å†åˆ°[è‡ªå·±çš„æ•°æ®åº“](https://console.neon.tech/app/projects/billowing-unit-66449389/branches/br-tiny-dew-a1dwl43a/tables?database=metube)ä¸­ç¡®è®¤ src\app\api\users\webhook\route.ts çš„ webhook api æ˜¯å¦è¢«è§¦å‘æ‰§è¡Œï¼Œæ˜¯å¦æ­£ç¡®çš„å¯¹ users è¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚

# tRPC

tRPCï¼ˆTypeScript Remote Procedure Callï¼‰æ˜¯ä¸ºäº†è§£å†³å‰åç«¯ç±»å‹ä¸ä¸€è‡´ã€API æ¥å£é‡å¤å®šä¹‰ã€ä»¥åŠä¼ ç»Ÿ REST æˆ– GraphQL å¸¦æ¥çš„é¢å¤–è´Ÿæ‹…ç­‰é—®é¢˜è€Œè¯ç”Ÿçš„ã€‚

## é€‚ç”¨åœºæ™¯ï¼š

1. ä½¿ç”¨ TypeScript å¼€å‘çš„å…¨æ ˆé¡¹ç›®ï¼›
2. å¸Œæœ›åœ¨ å¼€å‘é˜¶æ®µå°±æ•æ‰æ¥å£é”™è¯¯ï¼›
3. é¡¹ç›®ä¸éœ€è¦ GraphQL çš„å¤æ‚æ€§ï¼Œä½†ä»æƒ³è¦è‰¯å¥½çš„ç±»å‹å®‰å…¨å’Œå¼€å‘ä½“éªŒï¼›
4. ç‰¹åˆ«é€‚åˆä¸ Next.jsï¼ˆæˆ–ä»»æ„ React æ¡†æ¶ï¼‰æ­é…ä½¿ç”¨ã€‚

## æ­¤é …ç›®çš„ trpc æ ¸å¿ƒæ–‡ä»¶æ¶æ§‹

1. æ ¸å¿ƒçµ„ä»¶å¯¼å‡ºï¼šsrc\trpc\init.ts<br/>
   é€šè¿‡ F12 æŸ¥çœ‹ createTRPCRouterï¼ŒcreateCallerFactoryï¼ŒprotectedProcedure ä¸‰å¤§æ ¸å¿ƒçš„ä½¿ç”¨ä½ç½®<br/>
   **createTRPCRouter**ç”¨äºç”Ÿæˆæ‰€æœ‰ API çš„å…¥å£è·¯ç”±ï¼šsrc\trpc\routers_app.ts<br/>
   API çš„å…¥å£è·¯ç”±ç”Ÿæˆåæ³¨å†Œåˆ° src\app\api\trpc\[trpc]\route.ts ä¸­å°±å¯ä»¥ç”Ÿæ•ˆäº†ã€‚
2. API çš„ contoller å®ç°æ–¹å¼ï¼Œä¸ hone å°è£… restfulAPI æ¥å£çš„æ–¹å¼å¾ˆç›¸ä¼¼<br/>
   API å…¥å£æ–‡ä»¶:src\app\api\trpc\[trpc]\route.ts<br/>
   API æ³¨å†Œæ–‡ä»¶:src\trpc\routers_app.ts<br/>
   API å®è£…æ–‡ä»¶ï¼šå„ä¸ª procedures.ts
3. API çš„è°ƒç”¨æ–¹å¼<br/>
   trpc æœåŠ¡ç«¯å–å‡ºæ•°æ®æ”¾å…¥ç¼“å­˜ï¼šsrc\app\(home)\page.tsx<br/>
   trpc å®¢æˆ·ç«¯ä»ç¼“å­˜ä¸­æå–æ•°æ®ï¼šsrc\modules\home\ui\sections\categories-section.tsx
4. HydrateClient<br/>
   åœ¨ @trpc/react-query/rsc ä¸­ï¼ŒcreateHydrationHelpers æä¾›çš„ HydrateClient æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äº åœ¨ RSC (React Server Components) ç¯å¢ƒä¸‹å®ç° TRPC çŠ¶æ€ hydration çš„å®¢æˆ·ç«¯ç»„ä»¶ã€‚å®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯å°†æœåŠ¡ç«¯é¢„è·å–çš„ TRPC æŸ¥è¯¢çŠ¶æ€å®‰å…¨åœ°æ³¨å…¥åˆ°å®¢æˆ·ç«¯ï¼Œå› ä¸ºæœ‰äº† HydrateClient çš„æ³¨å…¥ï¼Œsrc\modules\home\ui\sections\categories-section.tsx ä¸­çš„ useSuspenseQuery æ‰èƒ½å¤Ÿæ‹¿å¾—åˆ°æœåŠ¡ç«¯ç¼“å­˜çš„æ•°æ®ã€‚
5. useSuspenseQuery æ‹¿åˆ°çš„ç¼“å­˜æ•°æ®éœ€è¦é€šè¿‡ trpc çš„ prefetch æ¥å®Œæˆç¼“å­˜æ³¨å…¥ã€‚<br/>
   **æ³¨æ„:**prefetch ä¸èƒ½å† layout æ–‡ä»¶ä¸­å·¥ä½œã€‚åªèƒ½åœ¨ page ä¸­å·¥ä½œã€‚
6. useSuspenseInfiniteQuery æ‹¿åˆ°çš„ç¼“å­˜æ•°æ®éœ€è¦é€šè¿‡ trpc çš„ prefetchInfinite æ¥å®Œæˆç¼“å­˜æ³¨å…¥ã€‚<br/>
   **æ³¨æ„:**prefetchInfinite ä¸èƒ½å† layout æ–‡ä»¶ä¸­å·¥ä½œã€‚åªèƒ½åœ¨ page ä¸­å·¥ä½œã€‚

# Mux è§†é¢‘æ‰˜ç®¡

è°·æ­Œé‚®ç®±ç™»å½• Mux å¹³å°
![alt text](99_screenshot/mux_token.png)
![alt text](99_screenshot/mux_webhooks.png)

## webhook for mux

mux çš„ webhook æ˜¯è‡ªå·±å°è£…çš„åº“ï¼Œä¸éœ€è¦å€ŸåŠ© Svix<br/>
ä»£ç :src\app\api\videos\webhook\route.ts
